"use client";

import PageBreadcrumb from "@/components/common/PageBreadCrumb";
import { useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation"; 
import { toast } from "react-hot-toast"; 
import {
  PlusCircle,
  Eye,
  Download,
  Edit,
  Trash2,
  Paperclip,
  X,
  // ChevronDown dan Copy dihapus karena tidak lagi digunakan pada Tindakan
} from "lucide-react";
import Pagination from "@/components/tables/Pagination";

// ================== TYPES ==================
type Quotation = {
  id: number;
  quotationNumber: string;
  status: string;
  date: string;
  total: number;
  customer: string;
  attachmentUrl?: string | null;
};

// ================== EMPTY STATE ==================
function EmptyState() {
  return (
    <div className="mt-20 flex flex-col items-center justify-center text-center text-gray-600">
      <img src="/empty-state.svg" alt="Empty State" className="mb-4 w-64 opacity-90" />
      <p className="text-lg font-medium">Belum ada data yang ditampilkan</p>
      <p className="mt-2 max-w-md text-sm">
        Buat quotation penawaran yang dapat Anda akses dari semua perangkat Anda.
      </p>
      <Link
        href="/penjualan/quotation/add"
        className="mt-4 inline-flex items-center rounded-full bg-blue-600 px-4 py-2 text-white shadow-sm transition hover:bg-blue-700"
      >
        <PlusCircle className="mr-2 h-4 w-4" />
        <span>Buat Quotation Baru</span>
      </Link>
    </div>
  );
}

// ================== ROW ITEM (Diubah: Menggunakan Ikon Tindakan & Urutan Kolom Baru) ==================
function RowItem({
  quotation,
  handleAction,
}: {
  quotation: Quotation;
  handleAction: (action: string, id: number) => void;
}) {
  return (
    <tr className="border-t hover:bg-gray-50">
      <td className="p-3">{quotation.customer}</td>

      <td className="p-3">{quotation.quotationNumber}</td>

      <td className="p-3 text-right">
        {quotation.total
          ? quotation.total.toLocaleString("id-ID", {
              style: "currency",
              currency: "IDR",
            })
          : "Rp 0"}
      </td>

      <td className="p-3">{quotation.date}</td>

      <td className="p-3">
        <span
          className={`rounded-full px-2 py-1 text-xs ${
            quotation.status === "Confirmed"
              ? "bg-green-100 text-green-700"
              : quotation.status === "Draft"
              ? "bg-gray-100 text-gray-700"
              : "bg-yellow-100 text-yellow-700"
          }`}
        >
          {quotation.status}
        </span>
      </td>

      <td className="p-3 text-center">
        {quotation.attachmentUrl ? (
          <a
            href={quotation.attachmentUrl}
            target="_blank"
            rel="noopener noreferrer"
            className="inline-flex items-center justify-center text-blue-600 hover:text-blue-800"
          >
            <Paperclip className="h-4 w-4" />
          </a>
        ) : (
          "-"
        )}
      </td>

      <td className="p-3 text-right">
        <div className="inline-flex gap-1">
          <Link
            href={`/penjualan/quotation/${quotation.id}`}
            title="Lihat"
            className="p-2 rounded-full hover:bg-gray-100"
          >
            <Eye className="h-4 w-4 text-gray-600" />
          </Link>

          <button
            onClick={() => handleAction("edit", quotation.id)}
            title="Ubah"
            className="p-2 rounded-full hover:bg-gray-100"
          >
            <Edit className="h-4 w-4 text-gray-600" />
          </button>

          <button
            onClick={() => handleAction("download", quotation.id)}
            title="Unduh PDF"
            className="p-2 rounded-full hover:bg-gray-100"
          >
            <Download className="h-4 w-4 text-blue-600" />
          </button>

          <button
            onClick={() => handleAction("delete", quotation.id)}
            title="Hapus"
            className="p-2 rounded-full hover:bg-gray-100"
          >
            <Trash2 className="h-4 w-4 text-red-600" />
          </button>
        </div>
      </td>
    </tr>
  );
}


// ================== PAGE ==================
export default function QuotationPageWithTemplate() {
  const router = useRouter(); 
  const [quotations, setQuotations] = useState<Quotation[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  const [page, setPage] = useState(1);
  
  // PERUBAHAN 1: Default limit diubah dari 5 menjadi 10
  const [limit, setLimit] = useState(10); 
  const [deleteTarget, setDeleteTarget] = useState<Quotation | null>(null);
  const [deleteLoading, setDeleteLoading] = useState(false);

  const confirmDelete = async () => {
    if (!deleteTarget) return;
    setDeleteLoading(true);
    try {
      const res = await fetch(`/api/quotations/${deleteTarget.id}`, { method: "DELETE" });
      if (!res.ok) throw new Error();
      toast.success("Quotation berhasil dihapus");
      setQuotations((prev) => prev.filter((q) => q.id !== deleteTarget.id));
      setDeleteTarget(null);
      router.refresh();
    } catch {
      toast.error("Gagal menghapus quotation");
    } finally {
      setDeleteLoading(false);
    }
  };

  const handleAction = async (action: string, id: number) => {
    switch (action) {
      case "download": {
        const target = quotations.find((q) => q.id === id);
        const safeNumber = String(target?.quotationNumber ?? id).replace(/[^a-zA-Z0-9-_]/g, "_");
        const safeCustomer = (target?.customer ?? "Customer")
          .normalize("NFKD")
          .replace(/[^\w\s-]/g, "")
          .trim()
          .replace(/\s+/g, "_");
        try {
          const res = await fetch(`/api/quotations/${id}/pdf`);
          if (!res.ok) throw new Error();
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = `Quotation-${safeNumber}-${safeCustomer}.pdf`;
          document.body.appendChild(link);
          link.click();
          link.remove();
          URL.revokeObjectURL(url);
          toast.success("PDF quotation berhasil diunduh");
        } catch {
          toast.error("Gagal mengunduh PDF quotation");
        }
        break;
      }

      case "edit":
        router.push(`/penjualan/quotation/edit/${id}`);
        break;

      case "duplicate":
        // Logika duplicate dipertahankan dari versi sebelumnya
        try {
          const res = await fetch(`/api/quotations/${id}/duplicate`, { method: "POST" });
          if (!res.ok) throw new Error();
          toast.success("Quotation berhasil diduplikasi");
          router.refresh();
        } catch {
          toast.error("Gagal menduplikasi quotation");
        }
        break;

      case "delete": {
        const target = quotations.find((q) => q.id === id);
        setDeleteTarget(
          target ?? {
            id,
            quotationNumber: `QUO-${id}`,
            status: "",
            date: "",
            total: 0,
            customer: "",
            attachmentUrl: null,
          }
        );
        break;
      }

      default:
        break;
    }
  };

  useEffect(() => {
    const fetchQuotations = async () => {
      try {
        const res = await fetch("/api/quotations", { cache: "no-store" });
        const data = await res.json();
        const list = Array.isArray(data)
          ? data
          : Array.isArray((data as Record<string, unknown>)?.data)
          ? ((data as Record<string, unknown>).data as unknown[])
          : [];
        const mapped = list.map((entry) => {
          const item = entry as Record<string, unknown>;
          const rawCustomer = item["customer"];
          const companyName =
            typeof rawCustomer === "string"
              ? rawCustomer
              : typeof rawCustomer === "object" && rawCustomer && "company" in rawCustomer
              ? String((rawCustomer as Record<string, unknown>).company ?? "")
              : "";
          const customerName = companyName.trim() ? companyName : "Tidak diketahui";
          const status = typeof item["status"] === "string" ? item["status"] : "Draft";
          const dateValue = item["date"];
          const formattedDate =
            typeof dateValue === "string" && dateValue
              ? new Date(dateValue).toLocaleDateString("id-ID")
              : "-";
          const totalValue =
            typeof item["total"] === "number"
              ? item["total"]
              : typeof item["totalAmount"] === "number"
              ? item["totalAmount"]
              : 0;

          return {
            id: Number(item["id"] ?? 0),
            quotationNumber: String(item["quotationNumber"] ?? ""),
            status,
            date: formattedDate,
            total: Number(totalValue || 0),
            customer: customerName,
            attachmentUrl:
              typeof item["projectFileUrl"] === "string" ? (item["projectFileUrl"] as string) : null,
          };
        });
        setQuotations(mapped);

      } catch (err) {
        console.error("Gagal ambil quotation:", err);
      } finally {
        setLoading(false);
      }
    };
    fetchQuotations();
  }, [router]); 

  // Filter + Pagination
  const filtered = useMemo(
    () =>
      quotations.filter(
        (q) =>
          q.customer.toLowerCase().includes(searchTerm.toLowerCase()) ||
          q.quotationNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||
          q.status.toLowerCase().includes(searchTerm.toLowerCase())
      ),
    [quotations, searchTerm]
  );

  const totalPages = Math.ceil(filtered.length / limit);
  const paginated = filtered.slice((page - 1) * limit, page * limit);

  return (
    <div>
      <PageBreadcrumb pageTitle="Quotation Penjualan" />

      <div className="rounded-2xl border border-gray-200 bg-white p-6 dark:border-gray-800 dark:bg-white/[0.03]">
        {/* Toolbar atas */}
        <div className="mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <input
            type="text"
            placeholder="Cari pelanggan / nomor quotation..."
            value={searchTerm}
            onChange={(e) => {
              setSearchTerm(e.target.value);
              setPage(1);
            }}
            className="dark:bg-dark-900 shadow-theme-xs focus:border-brand-300 focus:ring-brand-500/10 dark:focus:border-brand-800 h-11 w-full sm:w-64 rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30"
          />

          <div className="flex items-center gap-3">
            <Link
              href="/penjualan/quotation/add"
              className="flex items-center rounded-full bg-blue-600 px-4 py-2 text-white shadow-sm transition hover:bg-blue-700"
            >
              <PlusCircle className="mr-2 h-4 w-4" />
              Buat Quotation Baru
            </Link>
          </div>
        </div>

        {/* Table */}
        {loading ? (
          <div className="py-20 text-center">Loading...</div>
        ) : paginated.length === 0 ? (
          <EmptyState />
        ) : (
          <>
            <div className="overflow-x-auto rounded-lg border bg-white shadow-sm">
              <table className="w-full text-sm">
                <thead className="bg-gray-50 text-gray-700">
                  <tr>
                    <th className="p-3 text-left">Customer</th>
                    <th className="p-3 text-left">No. Quotation</th>
                    
                    {/* Urutan kolom: Jumlah (kanan) */}
                    <th className="p-3 text-right">Jumlah</th> 

                    <th className="p-3 text-left">Tanggal</th>
                    
                    {/* Urutan kolom: Status (kiri) */}
                    <th className="p-3 text-left">Status</th> 

                    <th className="p-3 text-center">Lampiran</th>
                    <th className="p-3 text-right">Tindakan</th>
                  </tr>
                </thead>
                <tbody>
                  {paginated.map((q) => (
                    <RowItem key={q.id} quotation={q} handleAction={handleAction} />
                  ))}
                </tbody>
              </table>
            </div>

            {/* Pagination */}
            <Pagination
              currentPage={page}
              totalPages={totalPages}
              onPageChange={setPage}
              limit={limit}
              onLimitChange={(value) => {
                setLimit(value);
                setPage(1);
              }}
            />
          </>
        )}

      {deleteTarget ? (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
          <div className="w-full max-w-md rounded-xl bg-white p-6 shadow-2xl">
            <div className="flex items-center justify-between">
              <h3 className="text-lg font-semibold text-gray-800">Konfirmasi Hapus</h3>
              <button
                type="button"
                onClick={() => !deleteLoading && setDeleteTarget(null)}
                className="rounded-full p-1 text-gray-400 hover:bg-gray-100 hover:text-gray-600"
              >
                <X className="h-5 w-5" />
              </button>
            </div>
            <p className="mt-4 text-sm text-gray-600">
              Apakah Anda yakin ingin menghapus quotation
              <span className="font-medium text-gray-800"> {deleteTarget.quotationNumber}</span>? Tindakan ini tidak
              dapat dibatalkan.
            </p>
            <div className="mt-6 flex justify-end gap-3">
              <button
                type="button"
                onClick={() => setDeleteTarget(null)}
                className="rounded-lg border border-gray-300 px-4 py-2 text-sm hover:bg-gray-100"
                disabled={deleteLoading}
              >
                Batal
              </button>
              <button
                type="button"
                onClick={confirmDelete}
                className="rounded-lg bg-red-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-red-700 disabled:opacity-60"
                disabled={deleteLoading}
              >
                {deleteLoading ? "Menghapus..." : "Hapus"}
              </button>
            </div>
          </div>
        </div>
      ) : null}
      </div>
    </div>
  );
}
